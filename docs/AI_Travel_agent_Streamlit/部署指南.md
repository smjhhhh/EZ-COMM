# 🚀 部署指南

## 📋 目录

1. [部署前准备](#部署前准备)
2. [Streamlit Community Cloud 部署](#streamlit-community-cloud-部署) (推荐)
3. [Heroku 部署](#heroku-部署)
4. [Railway 部署](#railway-部署)
5. [Docker 部署](#docker-部署)
6. [自托管服务器部署](#自托管服务器部署)
7. [性能优化](#性能优化)
8. [监控与维护](#监控与维护)
9. [常见问题](#常见问题)

---

## 📝 部署前准备

### 1. 检查清单

在部署之前，确保完成以下准备工作:

- [ ] 代码已提交到 Git 仓库
- [ ] `.env` 文件已添加到 `.gitignore`
- [ ] 已获取所有必需的 API Keys
- [ ] 本地测试通过
- [ ] `requirements.txt` 是最新的
- [ ] README 文档已更新

### 2. 验证本地运行

```bash
# 确保本地运行正常
streamlit run streamlit_app.py

# 测试所有功能
# - API 连接
# - 搜索功能
# - 天气查询
# - 计算功能
```

### 3. 准备 API Keys

确保您有以下 API Keys:
- ✅ **OpenAI API Key** (必需)
- ⚠️ **Serper API Key** (推荐)
- ⚠️ **OpenWeatherMap API Key** (可选)

---

## ☁️ Streamlit Community Cloud 部署 (推荐)

### 为什么选择 Streamlit Cloud?

- ✅ **完全免费** (公开项目)
- ✅ **零配置** 自动部署
- ✅ **快速部署** 几分钟内上线
- ✅ **自动更新** Git push 即部署
- ✅ **内置 Secrets 管理**
- ✅ **无需信用卡**

### 步骤 1: 准备 GitHub 仓库

#### 1.1 创建 GitHub 仓库

```bash
# 初始化 Git (如果还没有)
git init
git add .
git commit -m "Initial commit"

# 创建 GitHub 仓库并推送
git remote add origin https://github.com/your-username/ai-travel-agent.git
git branch -M main
git push -u origin main
```

#### 1.2 确保 .gitignore 正确

`.gitignore` 应包含:
```
.env
__pycache__/
*.pyc
.vscode/
.idea/
venv/
*.log
```

### 步骤 2: 在 Streamlit Cloud 上部署

#### 2.1 登录 Streamlit Cloud

1. 访问 [share.streamlit.io](https://share.streamlit.io)
2. 点击 "Sign up" 或 "Sign in"
3. 使用 GitHub 账号登录
4. 授权 Streamlit 访问您的 GitHub 仓库

#### 2.2 创建新应用

1. 点击 "New app" 或 "Deploy an app"
2. 填写应用信息:
   - **Repository**: `your-username/ai-travel-agent`
   - **Branch**: `main`
   - **Main file path**: `streamlit_app.py`
   - **App URL** (optional): 自定义 URL (如 `my-travel-agent`)

3. 点击 "Deploy!"

### 步骤 3: 配置 Secrets

#### 3.1 添加 API Keys

1. 等待应用首次部署 (可能会失败，这是正常的)
2. 点击右上角 "⋮" → "Settings"
3. 选择左侧菜单的 "Secrets"
4. 在文本框中添加 (TOML 格式):

```toml
# Streamlit Secrets (TOML format)

# OpenAI API Key (必需)
OPENAI_API_KEY = "sk-proj-your_actual_openai_key_here"

# Google Serper API Key (推荐)
SERPER_API_KEY = "your_serper_api_key_here"

# OpenWeatherMap API Key (可选)
OPENWEATHERMAP_API_KEY = "your_weather_api_key_here"
```

5. 点击 "Save"
6. 应用会自动重新部署

### 步骤 4: 验证部署

1. 等待应用重新启动 (通常 1-2 分钟)
2. 访问您的应用 URL: `https://your-app-name.streamlit.app`
3. 检查侧边栏 API 状态:
   - ✅ OpenAI API 应该显示绿色
   - ✅ 其他 API 根据配置显示状态
4. 测试一个示例查询

### 步骤 5: 自动部署设置

Streamlit Cloud 默认启用自动部署:
- **每次 Git push** → **自动重新部署**
- **监控 main 分支** → **检测到更改时部署**

如果需要禁用自动部署:
1. Settings → General
2. 取消勾选 "Automatically deploy when changes are pushed"

### 管理应用

#### 查看日志
1. 在应用界面，点击右下角 "Manage app"
2. 查看 "Logs" 标签
3. 可以看到实时日志和错误信息

#### 重启应用
1. Settings → "Reboot app"
2. 或点击右上角 "⋮" → "Reboot"

#### 删除应用
1. Settings → "Delete app"
2. 输入应用名称确认

---

## 🟣 Heroku 部署

### 前提条件

- Heroku 账号
- Heroku CLI 已安装

### 步骤 1: 安装 Heroku CLI

```bash
# macOS
brew tap heroku/brew && brew install heroku

# Windows
# 下载安装程序: https://devcenter.heroku.com/articles/heroku-cli

# 验证安装
heroku --version
```

### 步骤 2: 登录 Heroku

```bash
heroku login
# 按任意键打开浏览器登录
```

### 步骤 3: 创建必需文件

#### 3.1 创建 `Procfile`

在项目根目录创建 `Procfile`:

```
web: sh setup.sh && streamlit run streamlit_app.py --server.port=$PORT --server.address=0.0.0.0
```

#### 3.2 创建 `setup.sh`

在项目根目录创建 `setup.sh`:

```bash
mkdir -p ~/.streamlit/

echo "\
[general]\n\
email = \"your-email@domain.com\"\n\
" > ~/.streamlit/credentials.toml

echo "\
[server]\n\
headless = true\n\
enableCORS=false\n\
port = $PORT\n\
" > ~/.streamlit/config.toml
```

#### 3.3 创建 `runtime.txt` (可选)

指定 Python 版本:

```
python-3.11.5
```

### 步骤 4: 创建 Heroku 应用

```bash
# 创建应用
heroku create your-travel-agent-app

# 或者让 Heroku 自动生成名称
heroku create
```

### 步骤 5: 配置环境变量

```bash
# 设置 OpenAI API Key (必需)
heroku config:set OPENAI_API_KEY=sk-proj-your_key_here

# 设置 Serper API Key (推荐)
heroku config:set SERPER_API_KEY=your_serper_key_here

# 设置 Weather API Key (可选)
heroku config:set OPENWEATHERMAP_API_KEY=your_weather_key_here

# 查看所有配置
heroku config
```

### 步骤 6: 部署应用

```bash
# 添加文件到 Git
git add Procfile setup.sh runtime.txt
git commit -m "Add Heroku deployment files"

# 部署到 Heroku
git push heroku main

# 如果你的主分支是 master
git push heroku master:main
```

### 步骤 7: 打开应用

```bash
# 自动在浏览器中打开应用
heroku open

# 查看日志
heroku logs --tail
```

### 管理 Heroku 应用

```bash
# 重启应用
heroku restart

# 查看应用信息
heroku info

# 进入应用 shell
heroku run bash

# 查看进程
heroku ps
```

---

## 🚂 Railway 部署

### 为什么选择 Railway?

- ✅ 简单易用
- ✅ 自动 HTTPS
- ✅ 免费额度 ($5/月)
- ✅ 快速部署

### 步骤 1: 注册 Railway

1. 访问 [railway.app](https://railway.app)
2. 使用 GitHub 账号注册/登录

### 步骤 2: 创建新项目

1. 点击 "New Project"
2. 选择 "Deploy from GitHub repo"
3. 选择您的仓库: `your-username/ai-travel-agent`
4. Railway 会自动检测 Python 项目

### 步骤 3: 配置环境变量

1. 在项目 Dashboard 中，点击项目
2. 选择 "Variables" 标签
3. 添加环境变量:
   - `OPENAI_API_KEY`: `sk-proj-your_key_here`
   - `SERPER_API_KEY`: `your_serper_key_here`
   - `OPENWEATHERMAP_API_KEY`: `your_weather_key_here`

### 步骤 4: 配置启动命令

1. 在 Settings 中找到 "Start Command"
2. 设置为:
```bash
streamlit run streamlit_app.py --server.port=$PORT --server.address=0.0.0.0
```

### 步骤 5: 生成域名

1. 在 Settings 中找到 "Domains"
2. 点击 "Generate Domain"
3. Railway 会自动分配一个域名，如:
   - `your-app.up.railway.app`

### 步骤 6: 部署

1. 点击 "Deploy"
2. 等待构建完成 (通常 2-5 分钟)
3. 访问生成的域名

---

## 🐳 Docker 部署

### 步骤 1: 创建 Dockerfile

在项目根目录创建 `Dockerfile`:

```dockerfile
FROM python:3.11-slim

# 设置工作目录
WORKDIR /app

# 复制依赖文件
COPY requirements.txt .

# 安装依赖
RUN pip install --no-cache-dir -r requirements.txt

# 复制应用代码
COPY . .

# 暴露端口
EXPOSE 8501

# 健康检查
HEALTHCHECK CMD curl --fail http://localhost:8501/_stcore/health

# 启动命令
ENTRYPOINT ["streamlit", "run", "streamlit_app.py", "--server.port=8501", "--server.address=0.0.0.0"]
```

### 步骤 2: 创建 .dockerignore

```
.env
__pycache__
*.pyc
.git
.gitignore
venv/
.vscode/
*.md
Dockerfile
.dockerignore
```

### 步骤 3: 构建 Docker 镜像

```bash
# 构建镜像
docker build -t ai-travel-agent .

# 查看镜像
docker images
```

### 步骤 4: 运行容器

```bash
# 运行容器
docker run -p 8501:8501 \
  -e OPENAI_API_KEY="sk-proj-your_key_here" \
  -e SERPER_API_KEY="your_serper_key_here" \
  -e OPENWEATHERMAP_API_KEY="your_weather_key_here" \
  ai-travel-agent

# 或使用 .env 文件
docker run -p 8501:8501 --env-file .env ai-travel-agent
```

### 步骤 5: 使用 Docker Compose (推荐)

创建 `docker-compose.yml`:

```yaml
version: '3.8'

services:
  app:
    build: .
    ports:
      - "8501:8501"
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - SERPER_API_KEY=${SERPER_API_KEY}
      - OPENWEATHERMAP_API_KEY=${OPENWEATHERMAP_API_KEY}
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8501/_stcore/health"]
      interval: 30s
      timeout: 10s
      retries: 3
```

运行:
```bash
# 启动
docker-compose up -d

# 查看日志
docker-compose logs -f

# 停止
docker-compose down
```

---

## 🖥️ 自托管服务器部署

### 方案 1: 使用 Nginx + Systemd

#### 步骤 1: 在服务器上设置项目

```bash
# 连接到服务器
ssh user@your-server-ip

# 克隆项目
git clone https://github.com/your-username/ai-travel-agent.git
cd ai-travel-agent

# 创建虚拟环境
python3 -m venv venv
source venv/bin/activate

# 安装依赖
pip install -r requirements.txt

# 配置环境变量
nano .env
# 添加您的 API Keys
```

#### 步骤 2: 创建 Systemd 服务

创建 `/etc/systemd/system/travel-agent.service`:

```ini
[Unit]
Description=AI Travel Agent Streamlit App
After=network.target

[Service]
Type=simple
User=www-data
WorkingDirectory=/path/to/ai-travel-agent
Environment="PATH=/path/to/ai-travel-agent/venv/bin"
EnvironmentFile=/path/to/ai-travel-agent/.env
ExecStart=/path/to/ai-travel-agent/venv/bin/streamlit run streamlit_app.py --server.port=8501 --server.address=127.0.0.1
Restart=always

[Install]
WantedBy=multi-user.target
```

启动服务:
```bash
# 重新加载 systemd
sudo systemctl daemon-reload

# 启动服务
sudo systemctl start travel-agent

# 设置开机自启
sudo systemctl enable travel-agent

# 查看状态
sudo systemctl status travel-agent
```

#### 步骤 3: 配置 Nginx

创建 `/etc/nginx/sites-available/travel-agent`:

```nginx
server {
    listen 80;
    server_name your-domain.com;

    location / {
        proxy_pass http://127.0.0.1:8501;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 86400;
    }
}
```

启用站点:
```bash
# 创建符号链接
sudo ln -s /etc/nginx/sites-available/travel-agent /etc/nginx/sites-enabled/

# 测试配置
sudo nginx -t

# 重启 Nginx
sudo systemctl restart nginx
```

#### 步骤 4: 配置 SSL (Let's Encrypt)

```bash
# 安装 Certbot
sudo apt install certbot python3-certbot-nginx

# 获取 SSL 证书
sudo certbot --nginx -d your-domain.com

# 自动续期已配置
```

---

## ⚡ 性能优化

### 1. 代码优化

#### 1.1 使用 Streamlit 缓存

```python
import streamlit as st

# 缓存 LLM 初始化
@st.cache_resource
def initialize_travel_agent():
    # ... 初始化代码
    return react_graph

# 缓存搜索结果
@st.cache_data(ttl=3600)  # 缓存 1 小时
def search_destination(query):
    # ... 搜索代码
    return results
```

#### 1.2 减少 Token 使用

```python
# 缩短系统提示词
system_prompt = SystemMessage("简洁的提示词...")

# 减少 max_tokens
llm = ChatOpenAI(
    model="gpt-4o",
    max_tokens=1000,  # 从 2000 减少到 1000
    temperature=0
)
```

#### 1.3 实现请求限流

```python
import time
from functools import wraps

def rate_limit(max_calls, time_window):
    calls = []
    def decorator(func):
        @wraps(func)
        def wrapper(*args, **kwargs):
            now = time.time()
            # 移除过期的调用
            calls[:] = [c for c in calls if c > now - time_window]
            if len(calls) >= max_calls:
                wait_time = calls[0] + time_window - now
                st.warning(f"请等待 {wait_time:.0f} 秒后再试")
                return None
            calls.append(now)
            return func(*args, **kwargs)
        return wrapper
    return decorator

# 使用
@rate_limit(max_calls=10, time_window=60)  # 每分钟最多 10 次
def call_openai_api(query):
    # ...
    pass
```

### 2. 服务器优化

#### 2.1 使用 CDN

对于静态资源，使用 CDN 加速:
- Cloudflare (免费)
- AWS CloudFront
- Google Cloud CDN

#### 2.2 启用 Gzip 压缩

Nginx 配置:
```nginx
gzip on;
gzip_vary on;
gzip_min_length 1024;
gzip_types text/plain text/css text/xml text/javascript application/json application/javascript;
```

#### 2.3 增加服务器资源

- **CPU**: 2 核心或更多
- **内存**: 至少 2GB RAM
- **磁盘**: 10GB+ 空间

---

## 📊 监控与维护

### 1. 应用监控

#### 1.1 Streamlit 内置监控

添加到 `streamlit_app.py`:

```python
# 添加使用统计
if 'query_count' not in st.session_state:
    st.session_state.query_count = 0

st.sidebar.metric("Total Queries", st.session_state.query_count)

# 记录每次查询
if st.button("🚀 Plan My Trip"):
    st.session_state.query_count += 1
    # ... 处理查询
```

#### 1.2 日志记录

```python
import logging
from datetime import datetime

# 配置日志
logging.basicConfig(
    filename='app.log',
    level=logging.INFO,
    format='%(asctime)s - %(levelname)s - %(message)s'
)

# 记录事件
logging.info(f"User query: {query}")
logging.error(f"API error: {error}")
```

### 2. API 使用监控

#### 2.1 OpenAI 使用量

定期检查:
1. 访问 [OpenAI Usage Dashboard](https://platform.openai.com/usage)
2. 查看每日/每月使用量
3. 设置预算警报

#### 2.2 错误监控

使用 Sentry 或类似服务:
```bash
pip install sentry-sdk
```

```python
import sentry_sdk

sentry_sdk.init(
    dsn="your-sentry-dsn",
    traces_sample_rate=1.0
)
```

### 3. 定期维护

#### 每周任务
- [ ] 检查应用日志
- [ ] 查看 API 使用量
- [ ] 测试主要功能
- [ ] 检查服务器资源使用

#### 每月任务
- [ ] 更新依赖包: `pip install --upgrade -r requirements.txt`
- [ ] 检查安全更新
- [ ] 备份数据和配置
- [ ] 检查 SSL 证书有效期

---

## ❓ 常见问题

### 1. Streamlit Cloud 问题

#### Q: 应用显示 "Sleeping"
**A**: 免费应用在无活动时会休眠。首次访问需要 10-30 秒唤醒。

#### Q: 部署失败
**A**: 检查:
1. `requirements.txt` 是否完整
2. Python 版本兼容性
3. 查看部署日志获取详细错误

#### Q: Secrets 不生效
**A**:
1. 确认 TOML 格式正确
2. 重启应用
3. 检查变量名拼写

### 2. Heroku 问题

#### Q: 应用崩溃 (R10 error)
**A**:
```bash
# 查看日志
heroku logs --tail

# 检查进程
heroku ps

# 重启应用
heroku restart
```

#### Q: 超出免费额度
**A**:
- Heroku 免费计划已取消
- 考虑使用 Streamlit Cloud 或 Railway

### 3. 性能问题

#### Q: 应用响应慢
**A**:
1. 实现缓存: `@st.cache_data`
2. 减少 max_tokens
3. 使用 gpt-3.5-turbo 代替 gpt-4
4. 增加服务器资源

#### Q: 内存使用高
**A**:
1. 限制 `chat_history` 长度
2. 定期清理 session_state
3. 使用更小的模型

---

## 📚 相关资源

- [Streamlit Cloud 文档](https://docs.streamlit.io/streamlit-community-cloud)
- [Heroku Python 部署指南](https://devcenter.heroku.com/categories/python-support)
- [Railway 文档](https://docs.railway.app)
- [Docker 官方文档](https://docs.docker.com)
- [Nginx 配置指南](https://nginx.org/en/docs/)

---

## 🎉 部署后清单

- [ ] 应用可以正常访问
- [ ] 所有 API 连接正常
- [ ] 测试示例查询功能正常
- [ ] HTTPS 已启用 (生产环境)
- [ ] 日志监控已配置
- [ ] 备份策略已建立
- [ ] 文档已更新，包含部署 URL
- [ ] 团队成员已通知

---

**恭喜! 您的 AI 旅行代理已成功部署! 🎊**

**最后更新**: 2025-10-17
**文档版本**: 1.0.0