# 🌍 AI 旅行代理开发文档

## 📋 目录
1. [项目简介](#项目简介)
2. [技术架构](#技术架构)
3. [项目结构](#项目结构)
4. [环境配置](#环境配置)
5. [核心模块说明](#核心模块说明)
6. [开发指南](#开发指南)
7. [测试指南](#测试指南)
8. [常见问题](#常见问题)

---

## 🎯 项目简介

AI 旅行代理是一个基于人工智能的旅行规划助手,能够帮助用户:
- 🌤️ 获取目的地实时天气信息
- 🏨 搜索酒店、景点、餐厅等旅游信息
- 💰 计算旅行费用并提供详细预算分解
- 💱 进行货币转换
- 🎥 推荐相关的旅行视频
- 📅 生成详细的每日行程安排

### 主要特点
- **智能对话**: 使用 GPT-4 模型理解用户需求
- **多工具集成**: 整合天气、搜索、视频等多个 API
- **精确计算**: 自动计算旅行总费用
- **实时数据**: 提供最新的天气和价格信息
- **美观界面**: 基于 Streamlit 的现代化 Web 界面

---

## 🏗️ 技术架构

### 技术栈

#### 前端框架
- **Streamlit**: Python Web 应用框架
  - 版本: ≥1.28.0
  - 用途: 构建交互式用户界面

#### AI 框架
- **LangChain**: LLM 应用开发框架
  - `langchain`: 核心库 (≥0.1.0)
  - `langchain-openai`: OpenAI 集成 (≥0.1.0)
  - `langchain-core`: 核心功能 (≥0.1.0)
  - `langchain-community`: 社区工具 (≥0.0.29)
  - `langchain-experimental`: 实验性功能 (≥0.0.56)

- **LangGraph**: 状态图管理
  - 版本: ≥0.0.45
  - 用途: 构建 AI Agent 工作流

#### AI 模型
- **OpenAI GPT-4o**: 主要语言模型
  - API: `openai` (≥1.0.0)
  - 参数: temperature=0, max_tokens=2000

#### 外部 API
- **OpenWeatherMap**: 天气数据 API
- **Google Serper**: 搜索数据 API
- **DuckDuckGo**: 备用搜索引擎
- **YouTube**: 视频搜索 API

#### 其他依赖
- **python-dotenv**: 环境变量管理 (≥1.0.0)
- **pandas**: 数据处理 (≥2.0.0)
- **numpy**: 数值计算 (≥1.24.0)
- **Pillow**: 图像处理 (≥10.0.0)
- **httpx**: HTTP 客户端 (≥0.24.0)
- **pydantic**: 数据验证 (≥2.0.0)

### 架构设计

```
用户输入
    ↓
Streamlit 界面
    ↓
LangGraph 状态机
    ↓
GPT-4o 模型决策
    ↓
工具调用 (Tools)
    ├── 天气查询
    ├── 搜索引擎
    ├── 数学计算
    ├── YouTube 搜索
    └── Python REPL
    ↓
结果整合与格式化
    ↓
返回给用户
```

---

## 📁 项目结构

```
AI_Travel_agent_Streamlit/
├── streamlit_app.py          # 主应用程序文件
├── run_script.py              # 运行脚本
├── requirements.txt           # Python 依赖包列表
├── .env                       # 环境变量配置 (不提交到 Git)
├── .gitignore                 # Git 忽略文件配置
│
├── README.md                  # 英文项目说明
├── 开发文档.md               # 中文开发文档 (本文件)
├── API配置指南.md            # API 配置详细说明
├── 部署指南.md               # 部署详细说明
│
├── github_upload_guide.md    # GitHub 上传指南
├── streamlit_guide.md        # Streamlit 配置指南
│
├── Assignment.ipynb          # 原始 Jupyter Notebook
│
└── .streamlit/               # Streamlit 配置目录 (可选)
    └── config.toml           # Streamlit 自定义配置
```

---

## ⚙️ 环境配置

### 1. 系统要求

- **Python**: 3.8 或更高版本
- **操作系统**: Windows / macOS / Linux
- **内存**: 建议 4GB 以上
- **网络**: 需要稳定的互联网连接

### 2. 安装依赖

#### 步骤 1: 克隆项目
```bash
git clone <your-repository-url>
cd AI_Travel_agent_Streamlit
```

#### 步骤 2: 创建虚拟环境 (推荐)
```bash
# 使用 venv
python -m venv venv

# 激活虚拟环境
# Windows:
venv\Scripts\activate
# macOS/Linux:
source venv/bin/activate
```

#### 步骤 3: 安装依赖包
```bash
pip install -r requirements.txt
```

### 3. 配置环境变量

创建 `.env` 文件并添加以下内容:

```env
# OpenAI API (必需)
OPENAI_API_KEY=your_openai_api_key_here

# Google Serper API (推荐，用于搜索)
SERPER_API_KEY=your_serper_api_key_here

# OpenWeatherMap API (可选，用于天气)
OPENWEATHERMAP_API_KEY=your_openweathermap_api_key_here
```

**重要提示:**
- `OPENAI_API_KEY` 是必需的，应用程序无法在没有它的情况下运行
- `SERPER_API_KEY` 如果未配置，系统会自动使用 DuckDuckGo 作为备用搜索引擎
- `OPENWEATHERMAP_API_KEY` 如果未配置，天气功能将不可用

### 4. 验证安装

```bash
# 检查 Python 版本
python --version

# 检查已安装的包
pip list | grep streamlit
pip list | grep langchain

# 测试 Streamlit 安装
streamlit hello
```

---

## 🔧 核心模块说明

### 1. 主应用文件 (streamlit_app.py)

#### 1.1 页面配置
```python
st.set_page_config(
    page_title="🌍 AI Travel Agent",
    page_icon="✈️",
    layout="wide",
    initial_sidebar_state="expanded"
)
```
配置 Streamlit 页面的基本属性。

#### 1.2 会话状态管理
```python
if 'travel_agent' not in st.session_state:
    st.session_state.travel_agent = None
if 'chat_history' not in st.session_state:
    st.session_state.chat_history = []
```
使用 Streamlit 的 session_state 来存储:
- `travel_agent`: LangGraph 编译后的状态图
- `chat_history`: 用户对话历史记录

#### 1.3 自定义工具 (Tools)

##### 数学计算工具
定义在 `streamlit_app.py:32-52`

```python
@tool
def addition(a: int, b: int) -> int:
    """加法运算"""
    return a + b

@tool
def multiply(a: int, b: int) -> int:
    """乘法运算"""
    return a * b

@tool
def division(a: int, b: int) -> float:
    """除法运算"""
    if b == 0:
        raise ValueError("Denominator cannot be zero.")
    return a / b

@tool
def substraction(a: int, b: int) -> float:
    """减法运算"""
    return a - b
```

**用途**: 用于计算旅行费用，如酒店总价、餐饮费用等。

##### 天气查询工具
定义在 `streamlit_app.py:54-66`

```python
@tool
def get_weather(city: str) -> str:
    """获取城市的当前天气信息"""
    try:
        weather_api_key = st.secrets.get("OPENWEATHERMAP_API_KEY") or os.getenv("OPENWEATHERMAP_API_KEY")
        if weather_api_key:
            os.environ["OPENWEATHERMAP_API_KEY"] = weather_api_key
            weather = OpenWeatherMapAPIWrapper()
            return weather.run(city)
        else:
            return f"Weather API key not available. Cannot get weather for {city}."
    except Exception as e:
        return f"Weather data unavailable for {city}. Error: {str(e)}"
```

**特点**:
- 优先从 Streamlit secrets 读取 API key
- 回退到环境变量
- 包含错误处理

##### 搜索工具
定义在 `streamlit_app.py:68-90`

```python
@tool
def search_google(query: str) -> str:
    """使用 Google Serper API 搜索"""
    # Google Serper API 实现
    # 如果失败，自动回退到 DuckDuckGo

@tool
def search_duck(query: str) -> str:
    """使用 DuckDuckGo 搜索"""
    # DuckDuckGo 搜索实现
```

**搜索策略**:
1. 优先使用 Google Serper API (更准确)
2. 如果 Serper 不可用，自动切换到 DuckDuckGo
3. 提供搜索失败时的友好错误消息

##### YouTube 搜索工具
定义在 `streamlit_app.py:92-99`

```python
@tool
def youtube_search(query: str) -> str:
    """搜索 YouTube 旅行视频"""
    try:
        youtubetool = YouTubeSearchTool()
        return youtubetool.run(query)
    except Exception as e:
        return f"YouTube search unavailable. Error: {str(e)}"
```

##### Python REPL 工具
定义在 `streamlit_app.py:102-107`

```python
python_repl = PythonREPL()
repl_tool = Tool(
    name="python_repl",
    description="A Python shell for complex calculations. Input should be a valid python command.",
    func=python_repl.run,
)
```

**用途**: 执行复杂的 Python 计算，如汇率转换、百分比计算等。

#### 1.4 旅行代理初始化
定义在 `streamlit_app.py:109-200`

```python
def initialize_travel_agent():
    """初始化旅行代理"""
    # 1. 获取 OpenAI API key
    openai_api_key = st.secrets.get("OPENAI_API_KEY") or os.getenv("OPENAI_API_KEY")

    # 2. 初始化 GPT-4o 模型
    llm = ChatOpenAI(
        model="gpt-4o",
        temperature=0,
        max_tokens=2000,
        api_key=openai_api_key
    )

    # 3. 定义系统提示词
    system_prompt = SystemMessage("""...""")

    # 4. 绑定工具到 LLM
    llm_with_tools = llm.bind_tools(tools)

    # 5. 构建 LangGraph 状态图
    builder = StateGraph(MessagesState)
    builder.add_node("llm_decision_step", function_1)
    builder.add_node("tools", ToolNode(tools))
    builder.add_edge(START, "llm_decision_step")
    builder.add_conditional_edges("llm_decision_step", tools_condition)
    builder.add_edge("tools", "llm_decision_step")

    # 6. 编译并返回状态图
    react_graph = builder.compile()
    return react_graph
```

**工作流程**:
1. **START** → LLM 决策节点
2. LLM 决策 → 条件判断 (是否需要调用工具)
3. 如需工具 → 工具节点 → 返回 LLM 决策
4. 如不需要 → END

#### 1.5 系统提示词设计
定义在 `streamlit_app.py:129-169`

系统提示词定义了 AI 的行为规则:

```
步骤 1: 始终先调用 get_weather 获取天气
步骤 2: 调用搜索工具查找酒店、景点、餐厅价格
       - 如需货币转换，搜索实时汇率
步骤 3: 使用数学工具计算所有费用
步骤 4: 调用 youtube_search 查找相关视频
步骤 5: 生成详细的每日行程和费用分解
```

**输出格式要求**:
- 🌤️ 天气信息
- 💱 货币转换
- 🏛️ 景点与活动
- 🏨 酒店与住宿
- 📅 每日行程
- 💰 费用分解
- 🎥 YouTube 资源
- 📋 总结

#### 1.6 主函数 (main)
定义在 `streamlit_app.py:202-317`

```python
def main():
    # 1. 显示页面头部
    st.markdown("""...""", unsafe_allow_html=True)

    # 2. 侧边栏 API 状态检查
    st.sidebar.header("📡 API Status")
    # 检查并显示各个 API 的状态

    # 3. 主内容区域
    st.header("💬 Travel Query")

    # 4. 示例查询选择器
    example_queries = {...}
    selected_example = st.selectbox(...)

    # 5. 用户输入区域
    query = st.text_area(...)

    # 6. 处理按钮点击
    if st.button("🚀 Plan My Trip"):
        # 初始化代理
        if st.session_state.travel_agent is None:
            st.session_state.travel_agent = initialize_travel_agent()

        # 处理查询
        response = st.session_state.travel_agent.invoke({
            "messages": [HumanMessage(query)]
        })

        # 显示结果
        final_response = response["messages"][-1].content
        st.markdown(final_response)

        # 保存到历史记录
        st.session_state.chat_history.append({
            "query": query,
            "response": final_response
        })
```

---

## 💻 开发指南

### 1. 添加新工具

#### 步骤 1: 定义工具函数
```python
@tool
def your_new_tool(param: str) -> str:
    """工具描述 - 这个描述会被 AI 用来理解工具用途"""
    try:
        # 实现工具逻辑
        result = your_implementation(param)
        return result
    except Exception as e:
        return f"Error: {str(e)}"
```

#### 步骤 2: 添加到工具列表
在 `initialize_travel_agent` 函数中:
```python
tools = [
    addition, multiply, division, substraction,
    get_weather, search_google, search_duck,
    repl_tool, youtube_search,
    your_new_tool  # 添加你的新工具
]
```

#### 步骤 3: 更新系统提示词
在系统提示词中说明何时使用新工具:
```python
system_prompt = SystemMessage("""
...
STEP X: 在 [某种情况] 下调用 your_new_tool
...
""")
```

### 2. 修改 AI 行为

#### 调整模型参数
```python
llm = ChatOpenAI(
    model="gpt-4o",              # 模型名称
    temperature=0,                # 0=确定性, 1=创造性
    max_tokens=2000,              # 最大输出长度
    api_key=openai_api_key
)
```

**参数说明**:
- `temperature`:
  - 0: 输出最确定、最一致
  - 0.5-0.7: 平衡创造性和一致性
  - 1: 最具创造性和随机性
- `max_tokens`: 控制响应长度 (1 token ≈ 0.75 个英文单词)

#### 修改系统提示词
编辑 `streamlit_app.py:129-169` 中的 `system_prompt`:
- 添加新的步骤
- 修改输出格式
- 调整 AI 的个性和语气

### 3. 自定义界面

#### 修改页面样式
```python
st.markdown("""
<style>
.main-header {
    background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 2rem;
    border-radius: 10px;
}
</style>
""", unsafe_allow_html=True)
```

#### 添加新的输入控件
```python
# 滑块
budget = st.slider("预算范围 (CNY)", 1000, 50000, 10000)

# 日期选择器
travel_date = st.date_input("出发日期")

# 多选框
interests = st.multiselect(
    "兴趣爱好",
    ["历史文化", "自然风光", "美食", "购物", "冒险运动"]
)
```

### 4. 调试技巧

#### 启用详细日志
```python
import logging

logging.basicConfig(level=logging.DEBUG)
logger = logging.getLogger(__name__)

# 在关键位置添加日志
logger.debug(f"User query: {query}")
logger.debug(f"Tool response: {tool_result}")
```

#### 使用 Streamlit 调试工具
```python
# 显示变量内容
st.write("Debug info:", variable)

# 显示 JSON 数据
st.json({"key": "value"})

# 显示代码
st.code("""
def example():
    pass
""", language="python")
```

#### 查看工具调用历史
```python
# 在处理响应后添加
if st.checkbox("显示调试信息"):
    st.write("完整响应:", response)
    st.write("所有消息:", response["messages"])
```

---

## 🧪 测试指南

### 1. 本地测试

#### 启动应用
```bash
streamlit run streamlit_app.py
```

#### 基本功能测试清单
- [ ] 应用是否正常启动
- [ ] 侧边栏 API 状态是否正确显示
- [ ] 示例查询是否可以选择
- [ ] 文本输入框是否正常工作
- [ ] 按钮点击是否有响应

### 2. 功能测试

#### 测试用例 1: 天气查询
```
输入: 查询北京的天气
期望输出: 包含北京当前天气信息
```

#### 测试用例 2: 简单旅行计划
```
输入: 我想去上海玩 3 天
期望输出:
- 上海天气
- 酒店推荐
- 景点推荐
- 费用计算
- YouTube 视频
```

#### 测试用例 3: 复杂预算计算
```
输入: 我有 5000 元预算，想去三亚 5 天，包括酒店、餐饮和门票
期望输出:
- 详细费用分解
- 每项费用的计算过程
- 是否超出预算
```

#### 测试用例 4: 货币转换
```
输入: 我有 1000 美元预算，想去泰国 4 天，把所有费用转换成人民币
期望输出:
- 当前汇率
- 美元费用
- 人民币等值
```

### 3. 错误处理测试

#### 测试场景 1: 缺少 API Key
1. 移除 `.env` 中的 `OPENAI_API_KEY`
2. 启动应用
3. 期望: 显示错误提示，要求配置 API Key

#### 测试场景 2: API 调用失败
1. 使用无效的 API Key
2. 尝试发起查询
3. 期望: 显示友好的错误消息

#### 测试场景 3: 网络问题
1. 断开网络连接
2. 尝试发起查询
3. 期望: 显示网络错误提示

### 4. 性能测试

#### 响应时间测试
```python
import time

start_time = time.time()
response = st.session_state.travel_agent.invoke({"messages": [HumanMessage(query)]})
end_time = time.time()

st.info(f"响应时间: {end_time - start_time:.2f} 秒")
```

#### 并发测试
使用多个浏览器标签同时访问应用，检查:
- 会话状态是否隔离
- 是否存在资源竞争
- 响应时间是否明显增加

---

## ❓ 常见问题

### 1. 安装问题

#### Q: 安装依赖时出现错误
```
ERROR: Could not find a version that satisfies the requirement...
```

**A**: 解决方案:
```bash
# 更新 pip
pip install --upgrade pip

# 使用国内镜像源
pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple
```

#### Q: Streamlit 命令未找到
```
streamlit: command not found
```

**A**: 解决方案:
```bash
# 确保虚拟环境已激活
source venv/bin/activate  # macOS/Linux
venv\Scripts\activate     # Windows

# 重新安装 Streamlit
pip install streamlit
```

### 2. API 相关问题

#### Q: OpenAI API 调用失败
```
Error: Invalid API key
```

**A**: 检查清单:
1. API Key 是否正确复制 (无多余空格)
2. `.env` 文件格式是否正确
3. API Key 是否有足够的额度
4. 网络是否可以访问 OpenAI API

#### Q: 天气 API 不工作
```
Weather data unavailable
```

**A**: 解决方案:
1. 检查 `OPENWEATHERMAP_API_KEY` 是否配置
2. 验证 API Key 是否有效
3. 检查城市名称拼写是否正确
4. 确认 OpenWeatherMap 服务是否正常

### 3. 运行时问题

#### Q: 应用启动慢
**A**: 可能原因和优化:
- 首次初始化 LangGraph 较慢，属于正常现象
- 使用 `@st.cache_resource` 缓存 travel_agent 初始化
- 考虑减小 max_tokens 值

#### Q: 响应不符合预期
**A**: 调试步骤:
1. 检查系统提示词是否清晰
2. 启用调试模式查看工具调用
3. 调整 temperature 参数
4. 增加或减少 max_tokens

#### Q: 内存使用过高
**A**: 优化建议:
- 限制 `chat_history` 的长度
- 定期清理 session_state
- 使用更小的模型 (如 gpt-3.5-turbo)

### 4. 开发问题

#### Q: 如何添加新的 API?
**A**: 步骤:
1. 在 `.env` 中添加新的 API Key
2. 创建新的工具函数 `@tool`
3. 在 tools 列表中注册
4. 更新系统提示词说明用途

#### Q: 如何修改输出格式?
**A**: 修改位置:
- 系统提示词中的 FORMAT 部分 (streamlit_app.py:161-168)
- 可以添加新的 emoji 和章节标题
- 调整输出的详细程度

#### Q: 如何支持其他语言模型?
**A**: 修改示例:
```python
# 使用其他 OpenAI 模型
llm = ChatOpenAI(model="gpt-3.5-turbo", ...)

# 使用本地模型 (需要额外配置)
from langchain_community.llms import Ollama
llm = Ollama(model="llama2")
```

---

## 📚 扩展阅读

- [Streamlit 官方文档](https://docs.streamlit.io)
- [LangChain 文档](https://python.langchain.com)
- [LangGraph 文档](https://langchain-ai.github.io/langgraph/)
- [OpenAI API 文档](https://platform.openai.com/docs)

---

## 📞 技术支持

如果您遇到问题:
1. 查看本文档的常见问题部分
2. 检查项目的 GitHub Issues
3. 查阅相关技术文档
4. 联系项目维护者

---

**最后更新**: 2025-10-17
**文档版本**: 1.0.0
